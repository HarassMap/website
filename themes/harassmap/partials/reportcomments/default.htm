<div class="rainlab-forum">

    {% flash %}
    <div class="alert alert-{{ type == 'error' ? 'danger' : type }}">
        {{ message }}
        <button type="button" class="close" data-dismiss="alert" aria-hidden="true">&times;</button>
    </div>
    {% endflash %}

    {% if topic %}

        <div class="row">
            <div class="col-12">

                <div class="forum-posts">
                    {% for post in posts %}
                        <div class="forum-post" data-post-id="{{ post.id }}" id="post-{{ post.id }}">
                            <div class="content">
                                {{ post.member.user.username }}
                                <div class="metadata">
                                    <div class="date">
                                        <a href="#post-{{ post.id }}">
                                            {% partial __SELF__ ~ "::timestamp" date=post.created_at %}
                                        </a>
                                    </div>
                                    {% if post.member.is_banned %}
                                        <div class="status text-danger">
                                            <i class="icon-exclamation"></i> Banned
                                        </div>
                                    {% elseif post.member.is_moderator %}
                                        <div class="status">
                                            <i class="icon-star"></i> Moderator
                                        </div>
                                    {% endif %}
                                </div>

                                {% if mode == 'edit' %}

                                    {{ form_open() }}
                                    <!-- Passable fields -->
                                    <input type="hidden" name="mode" value="save"/>
                                    <input type="hidden" name="post" value="{{ post.id }}"/>

                                    {% if topic.first_post.id == post.id %}
                                        <input type="text" name="subject" class="form-control"
                                               value="{{ topic.subject }}"/>
                                    {% endif %}

                                    <div class="text">
                                        <textarea rows="5" name="content"
                                                  class="form-control">{{ post.content }}</textarea>
                                    </div>
                                    <div class="actions">
                                        <a
                                                href="javascript:;"
                                                data-request="{{ __SELF__ }}::onUpdate"
                                                data-request-data="post: {{ post.id }}"
                                                data-request-update="'{{ __SELF__ }}::post': '#post-{{ post.id }}'"
                                                class="save">
                                            Save
                                        </a>

                                        <a
                                                href="javascript:;"
                                                data-request="{{ __SELF__ }}::onUpdate"
                                                data-request-data="post: {{ post.id }}, mode: 'delete'"
                                                data-request-update="'{{ __SELF__ }}::post': '#post-{{ post.id }}'"
                                                data-request-confirm="Are you sure?"
                                                class="delete">
                                            Delete
                                        </a>

                                        <a href="javascript:;"
                                           data-request="{{ __SELF__ }}::onUpdate"
                                           data-request-data="post: {{ post.id }}, mode: 'view'"
                                           data-request-update="'{{ __SELF__ }}::post': '#post-{{ post.id }}'"
                                           class="cancel">
                                            Cancel
                                        </a>
                                    </div>
                                    {{ form_close() }}

                                {% elseif mode == 'delete' %}
                                    <div class="text">
                                        <p><em>Post has been deleted</em></p>
                                    </div>
                                {% else %}
                                    <div class="text">
                                        {{ post.content_html|raw }}

                                        {% if post.created_at != post.updated_at %}
                                            <p>
                                                <small class="text text-muted">
                                                    Last
                                                    updated {% partial __SELF__ ~ "::timestamp" date=post.updated_at %}
                                                </small>
                                            </p>
                                        {% endif %}
                                    </div>
                                    <div class="actions">
                                        {% if topic.canPost %}
                                            <a href="javascript:;"
                                               class="quote"
                                               data-request-data="post: {{ post.id }}"
                                               data-quote-button>
                                                Quote
                                            </a>
                                        {% endif %}
                                        {% if topic.canPost and post.canEdit and mode != 'edit' and mode != 'delete' %}
                                            <a href="javascript:;"
                                               class="edit"
                                               data-request="onUpdate"
                                               data-request-data="post: {{ post.id }}"
                                               data-request-update="'{{ __SELF__ ~ '::post' }}': '#post-{{ post.id }}'">
                                                Edit
                                            </a>
                                        {% endif %}
                                    </div>
                                {% endif %}

                            </div>
                            <div class="post-divider"></div>
                        </div>
                    {% endfor %}
                </div>

                {% partial "@pagination" %}

                {% if topic.canPost %}
                    <div class="reply-form mb-4" id="postForm">

                        <span class="help-block">
                            {{ 'You are commenting as :username' | _({username: member.user.username}) }}
                        </span>

                        {{ form_open({ request: 'onPost' }) }}

                        <input type="hidden" name="topic" value="{{ topic.id }}"/>

                        <textarea id="topicContent" name="content" rows="6"
                                  class="form-control">{{ form_value('content') }}</textarea>

                        <div class="mt-2">
                            <button type="submit" class="btn btn-primary btn-lg">{{ 'Post a Reply' | _ }}</button>
                        </div>

                        {{ form_close() }}

                    </div>
                {% endif %}

            </div>
        </div>

    {% elseif channel %}

        <h4>{{ 'Create a new discussion topic' | _ }}</h4>
        {% partial "@createform" %}

    {% else %}

        <p>{{ 'Topic not found' | _ }}</p>

    {% endif %}
</div>